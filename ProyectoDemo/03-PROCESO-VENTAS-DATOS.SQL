
SP_HELP DETALLEVENTA;
GO

SELECT * FROM CLIENTE;
SELECT * FROM USUARIO;
SELECT * FROM REPARTIDOR;
SELECT * FROM PRODUCTO;

-- VENTA NRO 1

INSERT INTO VENTA(IDVENTA,IDCLIENTE,FECHA,IDEMPLEADO,IDREPARTIDOR,REPARTODISTRITO,REPARTODIRECCION,COSTOENVIO,BASEIMPONIBLE,IMPUESTO,TOTAL)
VALUES(1,3,'20210615',3,7,1,'CALLE MI CASA 467',50,0,0,0);

INSERT INTO DETALLEVENTA(IDVENTA,IDPRODUCTO,CANTIDAD,PRECIO,SUBTOTAL)
VALUES(1,1,1,0,0);

INSERT INTO DETALLEVENTA(IDVENTA,IDPRODUCTO,CANTIDAD,PRECIO,SUBTOTAL)
VALUES(1,3,1,0,0);


-- VENTA NRO 2

INSERT INTO VENTA(IDVENTA,IDCLIENTE,FECHA,IDEMPLEADO,IDREPARTIDOR,REPARTODISTRITO,REPARTODIRECCION,COSTOENVIO,BASEIMPONIBLE,IMPUESTO,TOTAL)
VALUES(2,2,'20210617',4,7,1,'CALLE LOS ALGARROBOS 4356',50,0,0,0);

INSERT INTO DETALLEVENTA(IDVENTA,IDPRODUCTO,CANTIDAD,PRECIO,SUBTOTAL)
VALUES(2,2,1,0,0);

INSERT INTO DETALLEVENTA(IDVENTA,IDPRODUCTO,CANTIDAD,PRECIO,SUBTOTAL)
VALUES(2,3,2,0,0);




-- ACTUALIZAR DETALLE DE VENTA


UPDATE DETALLEVENTA 
SET PRECIO = P.PREVENTA,
	SUBTOTAL = P.PREVENTA * CANTIDAD
FROM PRODUCTO P
JOIN DETALLEVENTA DV ON P.IDPRODUCTO = DV.IDPRODUCTO;
GO

-- ACTUALIZAR VENTAS


UPDATE VENTA 
SET TOTAL = (SELECT SUM(SUBTOTAL) FROM DETALLEVENTA DV
			 WHERE DV.IDVENTA = VENTA.IDVENTA) + COSTOENVIO;
GO

UPDATE VENTA SET BASEIMPONIBLE = TOTAL / 1.18;
GO

UPDATE VENTA SET IMPUESTO = TOTAL - BASEIMPONIBLE;
GO


-- Actualizar contador de ventas

UPDATE CONTADOR 
SET ULTIMO = (SELECT MAX(IDVENTA) FROM VENTA)
WHERE IDCONTADOR = 5;
GO

SELECT * FROM CONTADOR;
GO
